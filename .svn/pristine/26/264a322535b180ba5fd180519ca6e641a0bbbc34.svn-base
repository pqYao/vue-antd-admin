<template>
  <a-card class="sign-up-vendor-wrapper">
    <Heading name="报名供应商">
      <template v-slot:leftIcon>
        <a-popover>
          <template slot="content">
            <p>邀请类的供应商报名后，系统将自动确认报名。</p>
          </template>
          <a-icon type="question-circle" />
        </a-popover>
      </template>
      <div v-if="pageType == 1">
        <!-- v-if="dataSource.length != 0 && (projectData.purchaseType == 1 || 
            projectData.purchaseType == 3 || 
            projectData.purchaseType == 5 || 
            projectData.purchaseType == 7)" -->
        <a-popconfirm 
          :disabled="isDisabled == 0"
          title="确定报名?" 
          @confirm="fnDeleteProduct(1)">
          <a-button type="primary" @click="fnDeleteProduct(2)"> 
            <!-- <i :class="['iconfont', 'icon-weibiaoti544']"></i> -->
            确认报名
          </a-button>
        </a-popconfirm>
      </div>
    </Heading>
    <a-table
      size="small"
      rowKey="providerEnrollId"
      :loading="pageData.loading"
      :pagination="false"
      :columns="columns"
      :dataSource="dataSource"
      :scroll="{ x: true }"
      :rowSelection="pageType == 0 ? null : {
        fixed: true,
        selectedRowKeys: selectedRowKeys,
        onChange: onSelectChange,
      }">
      <template slot="action" slot-scope="text, record">
        <!-- 分标完成展示查看按钮 -->
        <a
          style="margin-right: 8px"
          @click="fnConfirm(0, record.providerEnrollId)">
          确认报名
        </a>
      </template>
    </a-table>
    <pagination
      v-if="pageType == 1"
      :value="pageData.page"
      :pageSize="pageData.limit"
      v-show="pageData.total > 0"
      :total="pageData.total"
      @change="sizeChange"
      @showSizeChange="pageChange"
    ></pagination>
  </a-card>
</template>

<script>
import { mapGetters } from "vuex";
import Heading from "@/components/heading/Heading";
import Pagination from "@/components/pagination/Pagination";
import { getSignUpVendorData, getConfirmedSignUp } from "@/services/bid";

export default {
  name: "sign-up-vendor",
  components: { Pagination, Heading },
  props: {
    //0: 详情; 1: 编辑
    pageType: {
      type: [Number, String],
      default: 1
    },
    projectData: {
      type: Object,
      default() {
        return {}
      }
    }
  },
  data() {
    return {
      pageData: {
        limit: 15,
        total: 0,
        page: 1,
        loading: false
      },
      selectedRowKeys: [],
      selectedRows: [],
      dataSource: [],
      columns: [],
      columnsData: [
        {
          title: "序号",
          dataIndex: "number",
          align: "center",
          customRender: (text, record, index) =>
            `${(this.pageData.page - 1) * this.pageData.limit + index + 1}`,
          width: 80
        },
        {
          title: "供应商名称",
          dataIndex: "providerName"
        },
        {
          title: "供应商编码",
          dataIndex: "providerCode",
          align: "center"
        },
        {
          title: "联系人",
          dataIndex: "linkman",
          align: "center"
        },
        {
          title: "电话",
          dataIndex: "linkmanPhone",
          align: "center"
        },
        {
          title: "报名状态",
          dataIndex: "lin",
          align: "center"
        },
        {
          title: "操作",
          dataIndex: "action",
          align: "center",
          scopedSlots: { customRender: "action" },
        },
      ]
    };
  },
  computed: {
    ...mapGetters("account", ["dictionary"]),
    isDisabled() {
      //0: 未选确认报名的数据 1: 已选
      return this.selectedRowKeys.length == 0 ? 0 : 1
    }
  },
  created() {
    this.fnInit();
  },
  methods: {
    fnInit() {
      //详情界面不展示操作列
      this.columns = [];
      let arr = [...this.columnsData], index = this.columnsData.length - 1;
      // 编辑界面和公开类采购才展示操作列
      // (this.pageType == 1 && this.projectData.purchaseType != 1 || 3 || 5 || 7)
      if (this.pageType == 0) {
        arr.splice(index, 1);
      }
      this.columns = [...arr];
      this.fnGetData();
    },
    fnGetData() {
      let param = {
        limit: this.pageData.limit,
        page: this.pageData.page,
        projectId: this.$route.query.pid
      };
      this.pageData.loading = true;
      getSignUpVendorData(param).then(res => {
        const resData = res.data || {};
        const responseResult = resData.responseResult || {};
        if (resData.errCode == "0000") {
          const { data, total } = responseResult;
          this.dataSource = data;
          this.pageData.total = Number(total);
        } else {
         this.$error({
            title: "错误提示",
            content: this.BASE.handleErrorMsg(resData)
          });
        }
        this.pageData.loading = false;
      });
    },
    fnConfirm(type, id) {
      console.log('id', type, id);
      //type: 0 单条数据确认；1批量确认
      console.log(this.isDisabled);
      if (type == 2 && this.isDisabled == 0) {
        this.$message.warning("请选择确认报名的数据！");
        return;
      }
      if (type == 2) return;
      let ids = (type == 1) ? this.selectedRowKeys.join(',') : id;
      getConfirmedSignUp(ids).then(res => {
        const resData = res.data || {};
        if (resData.errCode == "0000") {
          this.$message.success(resData.responseResult, 3);
          this.fnGetData();
          //刷新确认报名供应商
          this.$emit('refresh-confirmed-vendor')
        } else {
          this.$error({
            title: "错误提示",
            content: this.BASE.handleErrorMsg(resData)
          });
        }
      })
    },
    onSelectChange(data, row) {
      this.selectedRowKeys = data;
      this.selectedRows = row;
    },
    sizeChange(page, pageSize) {
      this.pageData.page = page;
      this.pageData.limit = pageSize;
      this.getData();
    },
    pageChange(current, size) {
      this.pageData.page = current;
      this.pageData.limit = size;
      this.getData();
    }
  }
};
</script>
