<template>
	<div class="purchase-files-wrapper">
		<a-card>
      <Heading name="采购文件">
      	<template v-slot:leftIcon>
      		<a-popover>
						<template slot="content">
				      <p>1、费用不为0的采购文件须完成付款并等待采购方确认后才能下载；免费的采购文件可直接下载。</p>
				      <p>2、线上付款完成后，若付款状态未及时更新，请先联系工作人员处理，勿重复付款。</p>
				    </template>
      			<a-icon type="question-circle" />
      		</a-popover>
      	</template>
      	<a-button type="primary" @click="fnFresh" v-if="pageType == 1">
          <i :class="['iconfont', 'icon-baocun']"></i>
          刷新
        </a-button>
      </Heading>
      <a-table
        bordered
        size="small"
        class="es-table"
        rowKey="replyFileId"
        :loading="pageData.loading"
        :pagination="false"
        :columns="columns"
        :dataSource="dataSource"
        :scroll="{ x: true }">
    		<!-- 付款凭证 -->
        <template slot="paymentVoucher" slot-scope="text">
        	<a>{{text}}</a>
        </template>
        <!-- 付款状态 -->
        <template slot="operationState" slot-scope="text">
          {{ operationState[text] }}
        </template>
        <!-- 付款方式 -->
        <template slot="payMode" slot-scope="text">
          {{ dictionary.payMode ? dictionary.payMode[text] : '' }}
        </template>
        <template slot="action" slot-scope="text, record" v-if="pageType == 1">
          <a
            style="margin-right: 8px"
            @click="handleAction(record.projectId, 0)">
            线上付款
          </a>
          <a
            style="margin-right: 8px"
            @click="handleAction(record.projectId, 1)">
            线下付款
          </a>
          <a
            style="margin-right: 8px"
            @click="handleAction(record.projectId, 2)">
            取消付款
          </a>
          <a
            style="margin-right: 8px"
            @click="handleAction(record.projectId, 2)">
            下载采购文件
          </a>
          <a
            style="margin-right: 8px"
            @click="handleAction(record.projectId, 3)">
            上传付款凭证
          </a>
        </template>
      </a-table>
      <!-- 编辑界面不展示分页，显示全部的数据 -->
      <pagination
        v-if="pageType == 0"
        :value="pageData.page"
        :pageSize="pageData.limit"
        v-show="pageData.total > 0"
        :total="pageData.total"
        @change="sizeChange"
        @showSizeChange="pageChange"
      >
      </pagination>
    </a-card>
	</div>
</template>
<script>
	import { mapGetters } from "vuex";
	import { getPurchaseFilesList } from "@/services/response";
	import { operationStateMap } from "@/services/basic";
	// purchaseFilesPay
	export default {
		name: "purchase-files",
		components: {
			Heading: () => import("@/components/heading/Heading"),
			pagination: () => import("@/components/pagination/Pagination"),
		},
		props: {
			//0 详情界面，1 编辑界面
			pageType: {
				type: [String, Number],
				default: 0
			}
		},
		data() {
			return {
				operationState: [],
	      pageData: {
	        limit: 15,
	        total: 0,
	        page: 1,
	        loading: false
	      },
	      dataSource: [],
	      columns: [],
	      columnsData: [
	        {
	          title: "序号",
	          dataIndex: "number",
	          align: "center",
	          customRender: (text, record, index) => `${index + 1}`,
	          width: 80
	        },
	        {
	          title: "标名",
	          dataIndex: "tenderName",
	          width: 100
	        },
	        {
	          title: "包名",
	          dataIndex: "contractName",
	          width: 100,
	        },
	        {
	          title: "采购文件",
	          dataIndex: "2",
	          width: 160,
	          align: 'center'
	        },
	        {
	          title: "费用",
	          dataIndex: "bondMoney",
	          width: 140,
	          align: 'right'
	        },
	        {
	          title: "付款方式",
	          dataIndex: "payMode",
	          width: 100,
	          align: 'center',
	          scopedSlots: { customRender: "payMode" }
	        },
	        {
	          title: "付款状态",
	          dataIndex: "operationState",
	          width: 120,
	          align: 'center',
	          scopedSlots: { customRender: "operationState" }
	        },
	        {
	          title: "付款时间",
	          dataIndex: "payTime",
	          width: 160,
	          align: 'center'
	        },
	        {
	          title: "付款凭证",
	          dataIndex: "paymentVoucher",
	          width: 130,
	          align: 'center',
	          scopedSlots: { customRender: "paymentVoucher" },
	        },
	        {
	          title: "操作",
	          align: "center",
	          scopedSlots: { customRender: "action" },
	          width: 250,
	          fixed: 'right'
	        }
	      ]
			}
		},
		created() {
			this.fnInit();
		},
		computed: {
			...mapGetters("account", ["dictionary", "user"]),
			projectId() {
				return this.$route.params.id
			}
		},
		methods: {
			fnInit() {
				//详情界面不展示操作列
	      this.columns = [];
	      let arr = [...this.columnsData],
	        index = this.columnsData.length - 1;
	      if (this.pageType == 0) {
	        arr.splice(index, 1);
	      }
	      this.columns = [...arr];
	      this.fnGetData();
			},
			fnGetData(type) {
				let param = {
          limit: this.pageData.limit,
          page: this.pageData.page,
          projectId: this.projectId
        }
	      this.pageData.loading = true;
	      getPurchaseFilesList(param).then(res => {
	        const resData = res.data || {};
	        const responseResult = resData.responseResult || {};
	        if (resData.errCode == "0000") {
	          const { data, total } = responseResult;
	          this.dataSource = data;
	          this.pageData.total = Number(total);
	          if (type == 'refresh') {
	          	this.$message.success('刷新成功', 3);
	          }
	        } else {
	         this.$error({
	            title: "错误提示",
	            content: this.BASE.handleErrorMsg(resData)
	          });
	        }
	        this.pageData.loading = false;
	      });
			},
			//获取付款状态的码表值
	    getOperationStateList() {
	      operationStateMap("providerReply").then(result => {
	        const resData = result.data || {};
	        const responseResult = resData.responseResult || {};
	        if (resData.errCode === "0000") {
	          let arr = {};
	          for (var i in responseResult) {
	            let key = i.split("_");
	            if (!arr[key[0]]) arr[key[0]] = [];
	            arr[key[0]][key[1]] = resData.responseResult[i];
	          }
	          for (const key in arr) {
	            this.operationState = arr[key];
	          }
	        } else {
	          this.$error({
	            title: "错误提示",
	            content: this.BASE.handleErrorMsg(resData)
	          });
	        }
	      });
	    },
			fnFresh() {
				this.fnGetData('refresh');
			},
			handleAction(data, type) {
				switch(type) {
					case 0: 
						console.log(data);
						break;
					case 1: 
						console.log(data);
						break;
					case 2: 
						console.log(data);
						break;
					case 3: 
						console.log(data);
						break;
				}
			},
			sizeChange(page, pageSize) {
	      this.pageData.page = page;
	      this.pageData.limit = pageSize;
	      this.fnGetData();
	    },
	    pageChange(current, size) {
	      this.pageData.page = current;
	      this.pageData.limit = size;
	      this.fnGetData();
	    }
		}
	}
</script>